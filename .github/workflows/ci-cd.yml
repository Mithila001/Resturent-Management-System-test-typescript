name: CI/CD Pipeline

on:
  push: {}
  pull_request: {}
  workflow_dispatch: {}

jobs:
  backend-test:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./server

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit & Integration Tests
        run: npm test
        env:
          MONGO_URI: mongodb://localhost:27017/test_db
          JWT_SECRET: test_secret_key
          PORT: 5000

  frontend-build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./client

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18.x
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build Frontend
        run: npm run build

  e2e-test:
    needs: [backend-test, frontend-build]
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18.x
        uses: actions/setup-node@v3
        with:
          node-version: 18.x

      # Setup Backend
      - name: Install Backend Deps
        run: cd server && npm ci
      
      - name: Build Backend
        run: cd server && npm run build
      
      - name: Start Backend
        run: |
          cd server
          node dist/server.js &
          npx wait-on http://localhost:5000
        env:
          MONGO_URI: mongodb://localhost:27017/e2e_db
          JWT_SECRET: test_secret
          PORT: 5000

      # Setup Frontend
      - name: Install Frontend Deps
        run: cd client && npm ci

      - name: Start Frontend
        run: |
          cd client
          npm run dev -- --port 5173 &
          npx wait-on http://localhost:5173

      # Run Cypress
      - name: Install Cypress Deps (Root)
        run: npm install

      - name: Run E2E Tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headless: true
          # config-file: cypress.config.ts # optional if default
          wait-on: 'http://localhost:5173'
